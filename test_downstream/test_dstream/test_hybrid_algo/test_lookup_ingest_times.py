import functools
import typing

import numpy as np
import pytest

from downstream import dstream
from downstream.dstream import hybrid_algo as algo_class


def validate_lookup(fn: typing.Callable) -> typing.Callable:
    """Decorator to validate pre- and post-conditions on time lookup."""

    @functools.wraps(fn)
    def wrapper(S: int, T: int) -> typing.Iterable[typing.Optional[int]]:
        assert 0 <= T  # Assert T is non-negative
        res = fn(S, T)
        for v in res:
            assert v is None or 0 <= v < T  # Assert valid output
            yield v

    return wrapper


@pytest.mark.parametrize(
    "algo",
    [
        algo_class(0, dstream.steady_algo, 1),
        algo_class(0, dstream.steady_algo, 1, dstream.stretched_algo, 2),
        algo_class(0, dstream.tilted_algo, 1, dstream.tilted_algo, 2),
        algo_class(
            0,
            dstream.tilted_algo,
            1,
            dstream.tilted_algo,
            2,
            dstream.steady_algo,
            3,
        ),
        algo_class(
            0,
            dstream.steady_algo,
            2,
            dstream.stretched_algo,
            3,
            dstream.steady_algo,
            4,
        ),
        algo_class(
            0,
            dstream.steady_algo,
            1,
            dstream.stretched_algo,
            3,
            dstream.tilted_algo,
            4,
        ),
    ],
)
@pytest.mark.parametrize("s", range(1, 7))
def test_lookup_against_site_selection(algo: typing.Any, s: int):
    time_lookup = validate_lookup(algo.lookup_ingest_times)
    S = (1 << s) * algo._get_num_chunks()
    T_max = algo.get_ingest_capacity(S)
    if T_max is None:
        T_max = 2**14

    expected = [None] * S
    for T in range(min(T_max, 2**14)):
        actual = time_lookup(S, T)
        assert [*actual] == expected

        site = algo.assign_storage_site(S, T)
        if site is not None:
            expected[site] = T


@pytest.mark.parametrize(
    "algo",
    [
        algo_class(0, dstream.steady_algo, 1),
        algo_class(0, dstream.steady_algo, 1, dstream.stretched_algo, 2),
        algo_class(0, dstream.tilted_algo, 1, dstream.tilted_algo, 2),
        algo_class(
            0,
            dstream.steady_algo,
            2,
            dstream.stretched_algo,
            3,
            dstream.steady_algo,
            4,
        ),
        algo_class(
            0,
            dstream.steady_algo,
            1,
            dstream.stretched_algo,
            3,
            dstream.tilted_algo,
            4,
        ),
    ],
)
@pytest.mark.parametrize("s", range(1, 8))
@pytest.mark.parametrize(
    "T", [*range(10**2), *np.random.randint(2**63, size=10**2)]
)
def test_lookup_fuzz(algo: typing.Any, s: int, T: int):
    S = (1 << s) * algo._get_num_chunks()
    time_lookup = validate_lookup(algo.lookup_ingest_times)
    if not algo.has_ingest_capacity(S, T):
        T = S
    [*time_lookup(S, T)]


@pytest.mark.parametrize(
    "algo",
    [algo_class(0, dstream.steady_algo, 1, dstream.tilted_algo, 2)],
)
@pytest.mark.parametrize(
    "T",
    [
        189194,
        189382,
        189568,
        189610,
        189684,
        189694,
        189710,
        189718,
        189730,
        189734,
        189764,
        189766,
        189796,
        189806,
        189818,
        189834,
        189842,
        189872,
        189878,
        189884,
        189888,
        189894,
        189898,
        189902,
        189904,
        189908,
        189910,
        189912,
        189918,
        189924,
        189926,
        189932,
        189936,
        189940,
        189942,
        189944,
        189950,
        189952,
        189954,
        189956,
        189958,
        189960,
        189962,
        189968,
        189970,
        189974,
        189976,
        189978,
        189980,
        189982,
        189986,
        189988,
        189992,
        189994,
        189996,
        189998,
        190000,
        190002,
        190004,
        190008,
        190010,
        190012,
        190014,
        190016,
        190018,
        190020,
        190022,
        190024,
        190026,
        190028,
        190030,
        190032,
        190034,
        190036,
        190038,
        190040,
        190042,
        190044,
        190048,
        190050,
        190052,
        190054,
        190056,
        190058,
        190060,
        190062,
        190064,
        190066,
        190068,
        190070,
        190072,
        190074,
        190076,
        190078,
        190080,
        190082,
        190084,
        190086,
        190090,
        190092,
        190094,
        190096,
        190098,
        190100,
        190102,
        190104,
        190106,
        190108,
        190110,
        190112,
        190114,
        190116,
        190118,
        190120,
        190122,
        190126,
        190128,
        190130,
        190132,
        190134,
        190136,
        190138,
        190140,
        190142,
        190144,
        190146,
        190148,
        190150,
        190152,
        190154,
        190156,
        190158,
        190160,
        190162,
        190164,
        190166,
        190168,
        190170,
        190172,
        190174,
        190176,
        190178,
        190180,
        190182,
        190184,
        190186,
        190188,
        190190,
        190192,
        190194,
        190196,
        190198,
        190200,
        190202,
        190204,
        190206,
        190208,
        190210,
        190212,
        190214,
        190216,
        190218,
        190220,
        190222,
        190224,
        190226,
        190228,
        190230,
        190232,
        190234,
        190236,
        190238,
        190240,
        190242,
        190244,
        190246,
        190248,
        190250,
        190252,
        190254,
        190256,
        190258,
        190260,
        190262,
        190264,
        190266,
        190268,
        190270,
        190272,
        190274,
        190276,
        190278,
        190280,
        190282,
        190284,
        190286,
        190288,
        190290,
        190292,
        190294,
        190296,
        190298,
        190300,
        190302,
        190304,
        190306,
        190308,
        190310,
        190312,
        190314,
        190316,
        190318,
        190320,
        190322,
        190324,
        190326,
        190328,
        190330,
        190332,
        190334,
        190336,
        190338,
        190340,
        190342,
        190344,
        190346,
        190348,
        190350,
        190352,
        190354,
        190356,
        190358,
        190360,
        190362,
        190364,
        190366,
        190368,
        190370,
        190372,
        190374,
        190376,
        190378,
        190380,
        190382,
        190384,
        190386,
        190388,
        190390,
        190392,
        190394,
        190396,
        190398,
        190400,
        190402,
        190404,
        190406,
        190408,
        190410,
        190412,
        190414,
        190416,
        190418,
        190420,
        190422,
        190424,
        190426,
        190428,
        190430,
        190432,
        190434,
        190436,
        190438,
        190440,
        190442,
        190444,
        190446,
        190448,
        190450,
        190452,
        190454,
        190456,
        190458,
        190460,
        190462,
        190464,
        190466,
        190468,
        190470,
        190472,
        190474,
        190476,
        190478,
        190480,
        190482,
        190484,
        190486,
        190488,
        190490,
        190492,
        190494,
        190496,
        190498,
        190500,
        190502,
        190504,
        190506,
        190508,
        190510,
        190512,
        190514,
        190516,
        190518,
        190520,
        190522,
        190524,
        190526,
        190528,
        190530,
        190532,
        190534,
        190536,
        190538,
        190540,
        190542,
        190544,
        190546,
        190548,
        190550,
        190552,
        190554,
        190556,
        190558,
        190560,
        190562,
        190564,
        190566,
        190568,
        190570,
        190572,
        190574,
        190576,
        190578,
        190580,
        190582,
        190584,
        190586,
        190588,
        190590,
        190592,
        190594,
        190596,
        190598,
        190600,
        190602,
        190604,
        190606,
        190608,
        190610,
        190612,
        190614,
        190616,
        190618,
        190620,
        190622,
        190624,
        190626,
        190628,
        190630,
        190632,
        190634,
        190636,
        190638,
        190640,
        190642,
        190644,
        190646,
        190648,
        190650,
        190652,
        190654,
        190656,
        190658,
        190660,
        190662,
        190664,
        190666,
        190668,
        190670,
        190672,
        190674,
        190676,
        190678,
        190680,
        190682,
        190684,
        190686,
        190688,
        190690,
        190692,
        190694,
        190696,
        190698,
        190700,
        190702,
        190704,
        190706,
        190708,
        190710,
        190712,
        190714,
        190716,
        190718,
        190720,
        190722,
        190724,
        190726,
        190728,
        190730,
        190732,
        190734,
        190736,
        190738,
        190740,
        190742,
        190744,
        190746,
        190748,
        190750,
        190752,
        190754,
        190756,
        190758,
        190760,
        190762,
        190764,
        190766,
        190768,
        190770,
        190772,
        190774,
        190776,
        190778,
        190780,
        190782,
        190784,
        190786,
        190788,
        190790,
        190792,
        190794,
        190796,
        190798,
        190800,
        190802,
        190804,
        190806,
        190808,
        190810,
        190812,
        190814,
        190816,
        190818,
        190820,
        190822,
        190824,
        190826,
        190828,
        190830,
        190832,
        190834,
        190836,
        190838,
        190840,
        190842,
        190844,
        190846,
        190848,
        190850,
        190852,
        190854,
        190856,
        190858,
        190860,
        190862,
        190864,
        190866,
        190868,
        190870,
        190872,
        190874,
        190876,
        190878,
        190880,
        190882,
        190884,
        190886,
        190888,
        190890,
        190892,
        190894,
        190896,
        190898,
        190900,
        190902,
        190904,
        190906,
        190908,
        190910,
        190912,
        190914,
        190916,
        190918,
        190920,
        190922,
        190924,
        190926,
        190928,
        190930,
        190932,
        190934,
        190936,
        190938,
        190940,
        190942,
        190944,
        190946,
        190948,
        190950,
        190952,
        190954,
        190956,
        190958,
        190960,
        190962,
        190964,
        190966,
        190968,
        190970,
        190972,
        190974,
        190976,
        190978,
        190980,
        190982,
        190984,
        190986,
        190988,
        190990,
        190992,
        190994,
        190996,
        190998,
        191000,
        191002,
        191004,
        191006,
        191008,
        191010,
        191012,
        191014,
        191016,
        191018,
        191020,
        191022,
        191024,
        191026,
        191028,
        191030,
        191032,
        191034,
        191036,
        191038,
        191040,
        191042,
        191044,
        191046,
        191048,
        191050,
        191052,
        191054,
        191056,
        191058,
        191060,
        191062,
        191064,
        191066,
        191068,
        191070,
        191072,
        191074,
        191076,
        191078,
        191080,
        191082,
        191084,
        191086,
        191088,
        191090,
        191092,
        191094,
        191096,
        191098,
        191100,
        191102,
        191104,
        191106,
        191108,
        191110,
        191112,
        191114,
        191116,
        191118,
        191120,
        191122,
        191124,
        191126,
        191128,
        191130,
        191132,
        191134,
        191136,
        191138,
        191140,
        191142,
        191144,
        191146,
        191148,
        191150,
        191152,
        191154,
        191156,
        191158,
        191160,
        191162,
        191164,
        191166,
        191168,
        191170,
        191172,
        191174,
        191176,
        191178,
        191180,
        191182,
        191184,
        191186,
        191188,
        191190,
        191192,
        191194,
        191196,
        191198,
        191200,
        191202,
        191204,
        191206,
        191208,
        191210,
        191212,
        191214,
        191216,
        191218,
        191220,
        191222,
        191224,
        191226,
        191228,
        191230,
        191232,
        191234,
        191236,
        191238,
        191240,
        191242,
        191244,
        191246,
        191248,
        191250,
        191252,
        191254,
        191256,
        191258,
        191260,
        191262,
        191264,
        191266,
        191268,
        191270,
        191272,
        191274,
        191276,
        191278,
        191280,
        191282,
        191284,
        191286,
        191288,
        191290,
        191292,
        191294,
        191296,
        191298,
        191300,
        191302,
        191304,
        191306,
        191308,
        191310,
        191312,
        191314,
        191316,
        191318,
        191320,
        191322,
        191324,
        191326,
        191328,
        191330,
        191332,
        191334,
        191336,
        191338,
        191340,
        191342,
        191344,
        191346,
        191348,
        191350,
        191352,
        191354,
        191356,
        191358,
        191360,
        191362,
        191364,
        191366,
        191368,
        191370,
        191372,
        191374,
        191376,
        191378,
        191380,
        191382,
        191384,
        191386,
        191388,
        191390,
        191392,
        191394,
        191396,
        191398,
        191400,
        191402,
        191404,
        191406,
        191408,
        191410,
        191412,
        191414,
        191416,
        191418,
        191420,
        191422,
        191424,
        191426,
        191428,
        191430,
        191432,
        191434,
        191436,
        191438,
        191440,
        191442,
        191444,
        191446,
        191448,
        191450,
        191452,
        191454,
        191456,
        191458,
        191460,
        191462,
        191464,
        191466,
        191468,
        191470,
        191472,
        191474,
        191476,
        191478,
        191480,
        191482,
        191484,
        191486,
        191488,
        191490,
        191492,
        191494,
        191496,
        191498,
        191500,
        191502,
        191504,
        191506,
        191508,
        191510,
        191512,
        191514,
        191516,
        191518,
        191520,
        191522,
        191524,
        191526,
        191528,
        191530,
        191532,
        191534,
        191536,
        191538,
        191540,
        191542,
        191544,
        191546,
        191548,
        191550,
        191552,
        191554,
        191556,
        191558,
        191560,
        191562,
        191564,
        191566,
        191568,
        191570,
        191572,
        191574,
        191576,
        191578,
        191580,
        191582,
        191584,
        191586,
        191588,
        191590,
        191592,
        191594,
        191596,
        191598,
        191600,
        191602,
        191604,
        191606,
        191608,
        191610,
        191612,
        191614,
        191616,
        191618,
        191620,
        191622,
        191624,
        191626,
        191628,
        191630,
        191632,
        191634,
        191636,
        191638,
        191640,
        191642,
        191644,
        191646,
        191648,
        191650,
        191652,
        191654,
        191656,
        191658,
        191660,
        191662,
        191664,
        191666,
        191668,
        191670,
        191672,
        191674,
        191676,
        191678,
        191680,
        191682,
        191684,
        191686,
        191688,
        191690,
        191692,
        191694,
        191696,
        191698,
        191700,
        191702,
        191704,
        191706,
        191708,
        191710,
        191712,
        191714,
        191716,
        191718,
        191720,
        191722,
        191724,
        191726,
        191728,
        191730,
        191732,
        191734,
        191736,
        191738,
        191740,
        191742,
        191744,
        191746,
        191748,
        191750,
        191752,
        191754,
        191756,
        191758,
        191760,
        191762,
        191764,
        191766,
        191768,
        191770,
        191772,
        191774,
        191776,
        191778,
        191780,
        191782,
        191784,
        191786,
        191788,
        191790,
        191792,
        191794,
        191796,
        191798,
        191800,
        191802,
        191804,
        191806,
        191808,
        191810,
        191812,
        191814,
        191816,
        191818,
        191820,
        191822,
        191824,
        191826,
        191828,
        191830,
        191832,
        191834,
        191836,
        191838,
        191840,
        191842,
        191844,
        191846,
        191848,
        191850,
        191852,
        191854,
        191856,
        191858,
        191860,
        191862,
        191864,
        191866,
        191868,
        191870,
        191872,
        191874,
        191876,
        191878,
        191880,
        191882,
        191884,
        191886,
        191888,
        191890,
        191892,
        191894,
        191896,
        191898,
        191900,
        191902,
        191904,
        191906,
        191908,
        191910,
        191912,
        191914,
        191916,
        191918,
        191920,
        191922,
        191924,
        191926,
        191928,
        191930,
        191932,
        191934,
        191936,
        191938,
        191940,
        191942,
        191944,
        191946,
        191948,
        191950,
        191952,
        191954,
        191956,
        191958,
        191960,
        191962,
        191964,
        191966,
        191968,
        191970,
        191972,
        191974,
        191976,
        191978,
        191980,
        191982,
        191984,
        191986,
        191988,
        191990,
        191992,
        191994,
        191996,
        191998,
        192000,
        192002,
        192004,
        192006,
        192008,
        192010,
        192012,
        192014,
        192016,
        192018,
        192020,
        192022,
        192024,
        192026,
        192028,
        192030,
        192032,
        192034,
        192036,
        192038,
        192040,
        192042,
        192044,
        192046,
        192048,
        192050,
        192052,
        192054,
        192056,
        192058,
        192060,
        192062,
        192064,
        192066,
        192068,
        192070,
        192072,
        192074,
        192076,
        192078,
        192080,
        192082,
        192084,
        192086,
        192088,
        192090,
        192092,
        192094,
        192096,
        192098,
        192100,
        192102,
        192104,
        192106,
        192108,
        192110,
        192112,
        192114,
        192116,
        192118,
        192120,
        192122,
        192124,
        192126,
        192128,
        192130,
        192132,
        192134,
        192136,
        192138,
        192140,
        192142,
        192144,
        192146,
        192148,
        192150,
        192152,
        192154,
        192156,
        192158,
        192160,
        192162,
        192164,
        192166,
        192168,
        192170,
        192172,
        192174,
        192176,
        192178,
        192180,
        192182,
        192184,
        192186,
        192188,
        192190,
        192192,
        192194,
        192196,
        192198,
        192200,
        192202,
        192204,
        192206,
        192208,
        192210,
        192212,
        192214,
        192216,
        192218,
        192220,
        192222,
        192224,
        192226,
        192228,
        192230,
        192232,
        192234,
        192236,
        192238,
        192240,
        192242,
        192244,
        192246,
        192248,
        192250,
        192252,
        192254,
        192256,
        192258,
        192260,
        192262,
        192264,
        192266,
        192268,
        192270,
        192272,
        192274,
        192276,
        192278,
        192280,
        192282,
        192284,
        192286,
        192288,
        192290,
        192292,
        192294,
        192296,
        192298,
        192300,
        192302,
        192304,
        192306,
        192308,
        192310,
        192312,
        192314,
        192316,
        192318,
        192320,
        192322,
        192324,
        192326,
        192328,
        192330,
        192332,
        192334,
        192336,
        192338,
        192340,
        192342,
        192344,
        192346,
        192348,
        192350,
        192352,
        192354,
        192356,
        192358,
        192360,
        192362,
        192364,
        192366,
        192368,
        192370,
        192372,
        192374,
        192376,
        192378,
        192380,
        192382,
        192384,
        192386,
        192388,
        192390,
        192392,
        192394,
        192396,
        192398,
        192400,
        192402,
        192404,
        192406,
        192408,
        192410,
        192412,
        192414,
        192416,
        192418,
        192420,
        192422,
        192424,
        192426,
        192428,
        192430,
        192432,
        192434,
        192436,
        192438,
        192442,
        192444,
        192446,
        192448,
        192450,
        192452,
        192456,
        192458,
        192460,
        192462,
        192464,
        192466,
        192468,
        192470,
        192472,
        192474,
        192476,
        192478,
        192480,
        192482,
        192484,
        192486,
        192488,
        192490,
        192492,
        192494,
        192496,
        192498,
        192500,
        192502,
        192504,
        192506,
        192510,
        192512,
        192514,
        192516,
        192518,
        192520,
        192522,
        192524,
        192528,
        192530,
        192532,
        192536,
        192538,
        192540,
        192542,
        192546,
        192548,
        192550,
        192552,
        192554,
        192556,
        192558,
        192560,
        192562,
        192566,
        192570,
        192572,
        192576,
        192578,
        192580,
        192582,
        192586,
        192588,
        192590,
        192594,
        192598,
        192604,
        192606,
        192608,
        192612,
        192616,
        192618,
        192622,
        192626,
        192630,
        192634,
        192636,
        192642,
        192648,
        192670,
        192672,
        192678,
        192682,
        192690,
        192710,
        192712,
        192730,
        192742,
        192746,
        192756,
        192766,
        192804,
        192826,
        192832,
        192868,
        192870,
        192906,
        192936,
    ],
)
def test_bounds_regression(algo: typing.Any, T: int):
    S = 128
    res = algo.lookup_ingest_times(S, T)
    assert all(Tbar < T for Tbar in res)
